# di_web - AI Development Guide

## Overview

`@sudobility/di_web` is a TypeScript library that provides web-specific implementations of dependency injection services for Sudobility applications. It implements interfaces defined in `@sudobility/di` using browser APIs and React, and also ships a shared service worker with a Vite plugin for caching, push notifications, and offline support.

- **Package**: `@sudobility/di_web`
- **Version**: 0.1.106
- **License**: BUSL-1.1
- **Module**: ESM only (`"type": "module"`)
- **Package Manager**: Bun
- **Framework**: React 18/19, TypeScript 5.9+

## Project Structure

```
src/
├── index.ts                          # Main entry point; re-exports all public API
├── info/                             # Info/banner notification service
│   ├── index.ts                      # Barrel exports for info module
│   ├── info.web.ts                   # WebInfoService class, singleton management, BannerState type
│   └── InfoBanner.tsx                # InfoBanner component and useInfoBanner hook
├── initialize/                       # Centralized web app initialization
│   ├── index.ts                      # Barrel exports for initialize module
│   └── initialize.ts                 # initializeWebApp() orchestrator, WebAppInitOptions, RevenueCatConfig
└── sw/                               # Service worker utilities
    ├── index.ts                      # Barrel exports for sw module
    ├── register.ts                   # registerServiceWorker / unregisterServiceWorker helpers
    ├── vite-plugin-service-worker.ts # Vite plugin: emits sw.js into build output and serves it in dev
    ├── sw.js                         # Shared service worker (caching, push, background sync)
    └── firebase-messaging-sw.js      # Firebase Cloud Messaging background worker

tests/
└── index.test.ts                     # Vitest tests for WebInfoService (14 tests)

dist/                                 # Compiled output (auto-generated by tsc + cp)
```

## Key Services

### WebInfoService (`src/info/info.web.ts`)

Observable banner/notification service implementing `InfoInterface` from `@sudobility/di`.

- **State**: `BannerState { isVisible, title, description, variant, duration? }`
- **Methods**: `show(title, text, type, interval?)`, `dismiss()`, `subscribe(listener)`, `getState()`
- **Auto-dismiss**: defaults to 5000 ms; pass `0` to disable
- **Singleton functions**: `initializeInfoService()`, `getInfoService()`, `resetInfoService()`, `createWebInfoService()`
- Registers itself with `@sudobility/di` so `getInfoService()` works from either package

### InfoBanner / useInfoBanner (`src/info/InfoBanner.tsx`)

- `useInfoBanner()` -- React hook subscribing to `WebInfoService` state; returns `{ state, dismiss }`
- `InfoBanner` -- drop-in component using `<Banner>` from `@sudobility/components`; render once in app root

### initializeWebApp (`src/initialize/initialize.ts`)

Async orchestrator that sets up all DI services in order:

1. Storage service (`initializeStorageService`)
2. Firebase DI service (`initializeFirebaseService`)
3. Firebase Analytics singleton (`initializeFirebaseAnalytics`)
4. Network service (`initializeNetworkService`)
5. Info service (`initializeInfoService`)
6. RevenueCat subscription (optional, dynamically imported from `@sudobility/subscription_lib`)
7. i18n (optional callback)
8. Service worker registration / web vitals (optional)

Accepts `WebAppInitOptions` with required `firebaseConfig` and optional `revenueCatConfig`, `initializeI18n`, `registerServiceWorker`, `initWebVitals`.

### Service Worker (`src/sw/`)

- **sw.js** -- shared worker with three caching strategies (Cache First for static/images, Network First for HTML, Stale While Revalidate for locales), TTL-based expiration, size limits, push notification handling, background sync, and notification click routing
- **firebase-messaging-sw.js** -- Firebase Cloud Messaging background handler using Firebase compat SDK
- **registerServiceWorker()** -- registers `/sw.js` in production, sets up 24-hour update interval
- **serviceWorkerPlugin()** -- Vite plugin that emits `sw.js` (and optionally `firebase-messaging-sw.js`) into the build output and serves them during dev via middleware

The Vite plugin is exposed under a separate export path: `@sudobility/di_web/vite`.

## Development Commands

```bash
# Install dependencies
bun install

# Build the library (tsc + copy service worker JS files to dist/sw/)
bun run build

# Watch mode compilation
bun run build:watch

# Type checking only
bun run typecheck

# Clean dist directory
bun run clean

# Testing (Vitest, jsdom environment)
bun run test              # Run tests once
bun run test:watch        # Watch mode
bun run test:coverage     # With V8 coverage report
bun run test:ci           # CI-friendly (coverage enabled)

# Code quality
bun run lint              # ESLint
bun run lint:fix          # ESLint auto-fix
bun run format            # Prettier

# Pre-publish (runs clean, test, build)
bun run prepublishOnly
```

## Architecture / Patterns

### Singleton Pattern

Each service follows the same lifecycle:

1. `initialize*Service(instance?)` -- creates or accepts an instance, stores it in a module-scoped variable, and cross-registers with `@sudobility/di`
2. `get*Service()` -- returns the singleton or throws if not initialized
3. `reset*Service()` -- nullifies the singleton (testing only)

Only one initialization is honored; subsequent calls are no-ops.

### Observable / Listener Pattern

Services hold a `Set<Listener>` and expose `subscribe(listener): () => void`. Calling `subscribe` immediately invokes the listener with current state and returns an unsubscribe function. React hooks (`useInfoBanner`) wire this into `useState`/`useEffect`.

### Service Worker Caching Strategies

| Strategy                 | Used For                          | Cache Name            | TTL     |
|--------------------------|-----------------------------------|-----------------------|---------|
| Cache First              | JS, CSS, fonts, static assets     | sudobility-static-v1  | 7 days  |
| Cache First              | Images (png, jpg, svg, webp, etc) | sudobility-images-v1  | 30 days |
| Network First            | HTML pages, default               | sudobility-dynamic-v1 | 1 day   |
| Stale While Revalidate   | Locale files (`/locales/`)        | sudobility-dynamic-v1 | 1 day   |

Cache size limits: static 100, dynamic 50, images 30.

### DI Interface Implementation

All services implement interfaces from `@sudobility/di`. The package re-exports Firebase-related services and types from `@sudobility/di/web` for backward compatibility.

### Build Process

TypeScript compilation via `tsc` followed by a manual `cp` of `src/sw/sw.js` and `src/sw/firebase-messaging-sw.js` into `dist/sw/` (these are plain JS files not processed by tsc).

### TypeScript Configuration

- Target: ES2020, Module: ESNext, JSX: react-jsx
- Strict mode with all strict sub-options enabled
- Additional checks: `noUnusedLocals`, `noUnusedParameters`, `exactOptionalPropertyTypes`, `noImplicitReturns`, `noFallthroughCasesInSwitch`, `noUncheckedIndexedAccess`, `noImplicitOverride`
- Declaration + declaration maps + source maps emitted
- Tests excluded from compilation (`tsconfig.test.json` extends base with `noEmit`)

### ESLint Configuration

- Flat config (`eslint.config.js`) using `@typescript-eslint` + Prettier plugin
- Service worker JS files (`src/sw/*.js`) are ignored
- Unused vars with `_` prefix are allowed; unused function args are not checked

## Common Tasks

### Adding a New DI Service

1. Create `src/<service>/<service>.web.ts` implementing the corresponding interface from `@sudobility/di`
2. Define a state interface (e.g., `SomeState`) and listener type
3. Implement the observable pattern: `subscribe()`, `getState()`, private `setState()` with `listeners: Set<Listener>`
4. Add singleton functions: `initialize*Service()`, `get*Service()`, `reset*Service()`, `create*Service()`
5. Create React hook/component if needed (e.g., `use<Service>`, `<Service>Component.tsx`)
6. Export from `src/<service>/index.ts`
7. Export from `src/index.ts`
8. Add tests in `tests/`
9. Verify: `bun run typecheck && bun run test && bun run build`

### Showing a Banner from Anywhere

```typescript
import { getInfoService } from '@sudobility/di_web';
// OR: import { getInfoService } from '@sudobility/di';
import { InfoType } from '@sudobility/types';

getInfoService().show('Title', 'Description', InfoType.SUCCESS);       // auto-dismiss 5s
getInfoService().show('Title', 'Description', InfoType.ERROR, 10000);  // auto-dismiss 10s
getInfoService().show('Title', 'Description', InfoType.WARNING, 0);    // no auto-dismiss
getInfoService().dismiss();                                             // manual dismiss
```

### Using the Vite Service Worker Plugin

```typescript
// vite.config.ts
import { serviceWorkerPlugin } from '@sudobility/di_web/vite';

export default {
  plugins: [
    serviceWorkerPlugin({ includeFirebaseMessaging: true }),
  ],
};
```

### Fixing Type Errors

1. Run `bun run typecheck` to see all errors
2. Ensure implementations match `@sudobility/di` interface signatures exactly
3. Check that peer dependencies are installed in devDependencies at compatible versions

### Running Tests

Tests use Vitest with jsdom environment and fake timers. Coverage thresholds are 80% across branches, functions, lines, and statements.

```bash
bun run test           # quick run
bun run test:coverage  # with coverage report
```

## Peer / Key Dependencies

| Dependency                     | Role                                           | Required |
|--------------------------------|-------------------------------------------------|----------|
| `@sudobility/di`               | DI interface definitions and Firebase impls     | Yes      |
| `@sudobility/types`            | Shared type definitions (`InfoType`, `Optional`)| Yes      |
| `@sudobility/components`       | UI components (`Banner`)                        | Yes      |
| `react`                        | React 18 or 19                                  | Yes      |
| `vite`                         | Vite 5, 6, or 7 (for service worker plugin)     | Optional |
| `@sudobility/subscription_lib` | RevenueCat adapter (dynamically imported)        | Optional |

### Dev Dependencies of Note

- **vitest** + **@vitest/coverage-v8** -- test runner and coverage
- **jsdom** -- browser environment for tests
- **typescript** 5.9+ -- compiler
- **eslint** + **prettier** -- code quality
